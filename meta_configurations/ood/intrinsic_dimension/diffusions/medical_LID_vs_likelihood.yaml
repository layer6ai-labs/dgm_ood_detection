# This sweep compares the likelihood values of in and out of distribution
# for all the dataset pairs, containing the DGM generated ones
project: final-report
sweep_name: medical_diffusions_LID_vs_likelihood
entity: platypus-dgm
count: 10000
method: grid

# Change the name of the run to [in_distribution_dataset]_vs_[out_of_distribution_dataset]_[run_name]
# using the dysweep name changer for better readability
run_name_changer:
  expression: |
    from meta_configurations import *
  function_of_interest: ood_run_name_changer

# BASE configuration which is being used
base_config:
  data:
    # specify the datasets and dataloader configurations for the in and out of distribution data.
    in_distribution:
      dataloader_args:
        dataset: medmnist
        make_valid_loader: false
        train_batch_size: 128
        valid_batch_size: 128
        test_batch_size: 128
      pick_loader: train
    out_of_distribution:
      dataloader_args:
        dataset: medmnist
        make_valid_loader: false
        train_batch_size: 128
        valid_batch_size: 128
        test_batch_size: 128
      pick_loader: test
  ood:
    # bypass the entire visualization process since there is no need to plot the histograms that take time!
    bypass_visualization: True
  

    # for reproducibility
    seed: 100
    
    # The OOD detection method in use
      # The OOD detection method in use
    
    # The OOD detection method in use
    method: ood.intrinsic_dimension.LID_OOD
    method_args:
      # ----- LID estimator configuration -----
      lid_calculator_class: lid.diffusions.NormalBundleLIDEstimator
      lid_calculator_args:
          noise_time: 0.01
          num_scores: null # use 4D
          chunk_size: 128
          verbose: 2
          ambient_dim: 1024 # 1x32x32
      # ----- Likelihood Estimator Configuration -----
      likelihood_computation_args:
          eps: 0.01
          steps: 25
          trace_calculation_kwargs:
              method: hutchinson_rademacher 
              sample_count: 25
              parallel_batch_size: 128
              verbose: 0
          verbose: 1
      # ----- OOD detection configuration -----
      # verbosity
      verbose: 1
      checkpointing_buffer: 2
      # Hyper-parameters relating to the scale parameter that is being computed
      scale_selection_algorithm: given_from_model_free
      scale_selection_algorithm_args:
        l_scale: -100
        r_scale: 100
        bin_search_steps: 100

      training_buffer_size: 1
      
sweep_configuration:

  dy__upsert:
    - sweep: True
      sweep_identifier: B_task
      sweep_alias:
        # grayscale diffusions (Glow and RQ_NSF)
        - chest_aligned_vs_itself
        - chest_vs_pneumonia_aligned
        - pneumonia_vs_itself
        - pneumonia_vs_chest_aligned
        - organ_a_vs_itself
        - organ_a_vs_organ_s
        - organ_a_vs_organ_c
        - organ_s_vs_itself
        - organ_s_vs_organ_c
        - organ_s_vs_organ_a
        - organ_c_vs_itself
        - organ_c_vs_organ_a
        - organ_c_vs_organ_s
        - chest_vs_pneumonia
        - pneumonia_vs_chest
        - chest_vs_itself
      values:
        - base_model:
            config_dir: checkpoints-jjohg4sc/chest_xray_aligned_j11alw9w/run_config.json
            checkpoint_dir: checkpoints-jjohg4sc/chest_xray_aligned_j11alw9w/checkpoints/de_VPSDE_Diffusion_latest.pt
          data:
            in_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: ChestMNIST
                  align: True
            out_of_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: ChestMNIST
                  align: True
          ood:
            method_args:
              scale_selection_algorithm_args:
                model_free_dimension: 64 # Obtained by LPCA with threshold 0.001
        - base_model:
            config_dir: checkpoints-jjohg4sc/chest_xray_aligned_j11alw9w/run_config.json
            checkpoint_dir: checkpoints-jjohg4sc/chest_xray_aligned_j11alw9w/checkpoints/de_VPSDE_Diffusion_latest.pt
          data:
            in_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: ChestMNIST
                  align: True
            out_of_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: PneumoniaMNIST
          ood:
            method_args:
              scale_selection_algorithm_args:
                model_free_dimension: 64 # Obtained by LPCA with threshold 0.001
        - base_model:
            config_dir: checkpoints-jjohg4sc/pneumonia_chest_xray_v2lg5j0w/run_config.json
            checkpoint_dir: checkpoints-jjohg4sc/pneumonia_chest_xray_v2lg5j0w/checkpoints/de_VPSDE_Diffusion_latest.pt
          data:
            in_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: PneumoniaMNIST
            out_of_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: PneumoniaMNIST
          ood:
            method_args:
              scale_selection_algorithm_args:
                model_free_dimension: 98 # Obtained by LPCA with threshold 0.001 
        - base_model:
            config_dir: checkpoints-jjohg4sc/pneumonia_chest_xray_v2lg5j0w/run_config.json
            checkpoint_dir: checkpoints-jjohg4sc/pneumonia_chest_xray_v2lg5j0w/checkpoints/de_VPSDE_Diffusion_latest.pt
          data:
            in_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: PneumoniaMNIST
            out_of_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: ChestMNIST
                  align: True
          ood:
            method_args:
              scale_selection_algorithm_args:
                model_free_dimension: 98 # Obtained by LPCA with threshold 0.001
        - base_model:
            config_dir: checkpoints-jjohg4sc/organ_a_abdominal_og8vr850/run_config.json
            checkpoint_dir: checkpoints-jjohg4sc/organ_a_abdominal_og8vr850/checkpoints/de_VPSDE_Diffusion_latest.pt
          data:
            in_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganAMNIST
            out_of_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganAMNIST        
          ood:
            method_args:
              scale_selection_algorithm_args:
                model_free_dimension: 239 # Obtained by LPCA with threshold 0.001
        - base_model:
            config_dir: checkpoints-jjohg4sc/organ_a_abdominal_og8vr850/run_config.json
            checkpoint_dir: checkpoints-jjohg4sc/organ_a_abdominal_og8vr850/checkpoints/de_VPSDE_Diffusion_latest.pt
          data:
            in_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganAMNIST
            out_of_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganSMNIST          
          ood:
            method_args:
              scale_selection_algorithm_args:
                model_free_dimension: 239 # Obtained by LPCA with threshold 0.001
        - base_model:
            config_dir: checkpoints-jjohg4sc/organ_a_abdominal_og8vr850/run_config.json
            checkpoint_dir: checkpoints-jjohg4sc/organ_a_abdominal_og8vr850/checkpoints/de_VPSDE_Diffusion_latest.pt
          data:
            in_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganAMNIST
            out_of_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganCMNIST
          ood:
            method_args:
              scale_selection_algorithm_args:
                model_free_dimension: 239 # Obtained by LPCA with threshold 0.001
        - base_model:
            config_dir: checkpoints-jjohg4sc/organ_s_abdominal_lnnasywe/run_config.json
            checkpoint_dir: checkpoints-jjohg4sc/organ_s_abdominal_lnnasywe/checkpoints/de_VPSDE_Diffusion_latest.pt
          data:
            in_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganSMNIST
            out_of_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganSMNIST
          ood:
            method_args:
              scale_selection_algorithm_args:
                model_free_dimension: 224 # Obtained by LPCA with threshold 0.001
        - base_model:
            config_dir: checkpoints-jjohg4sc/organ_s_abdominal_lnnasywe/run_config.json
            checkpoint_dir: checkpoints-jjohg4sc/organ_s_abdominal_lnnasywe/checkpoints/de_VPSDE_Diffusion_latest.pt
          data:
            in_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganSMNIST
            out_of_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganCMNIST
          ood:
            method_args:
              scale_selection_algorithm_args:
                model_free_dimension: 224 # Obtained by LPCA with threshold 0.001
        - base_model:
            config_dir: checkpoints-jjohg4sc/organ_s_abdominal_lnnasywe/run_config.json
            checkpoint_dir: checkpoints-jjohg4sc/organ_s_abdominal_lnnasywe/checkpoints/de_VPSDE_Diffusion_latest.pt
          data:
            in_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganSMNIST
            out_of_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganAMNIST
          ood:
            method_args:
              scale_selection_algorithm_args:
                model_free_dimension: 224 # Obtained by LPCA with threshold 0.001
        - base_model:
            config_dir: checkpoints-jjohg4sc/organ_c_abdominal_4oll9enw/run_config.json
            checkpoint_dir: checkpoints-jjohg4sc/organ_c_abdominal_4oll9enw/checkpoints/de_VPSDE_Diffusion_latest.pt
          data:
            in_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganCMNIST
            out_of_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganCMNIST
          ood:
            method_args:
              scale_selection_algorithm_args:
                model_free_dimension: 267 # Obtained by LPCA with threshold 0.001
        - base_model:
            config_dir: checkpoints-jjohg4sc/organ_c_abdominal_4oll9enw/run_config.json
            checkpoint_dir: checkpoints-jjohg4sc/organ_c_abdominal_4oll9enw/checkpoints/de_VPSDE_Diffusion_latest.pt
          data:
            in_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganCMNIST
            out_of_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganAMNIST
          ood:
            method_args:
              scale_selection_algorithm_args:
                model_free_dimension: 267 # Obtained by LPCA with threshold 0.001
        - base_model:
            config_dir: checkpoints-jjohg4sc/organ_c_abdominal_4oll9enw/run_config.json
            checkpoint_dir: checkpoints-jjohg4sc/organ_c_abdominal_4oll9enw/checkpoints/de_VPSDE_Diffusion_latest.pt
          data:
            in_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganCMNIST
            out_of_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: OrganSMNIST
          ood:
            method_args:
              scale_selection_algorithm_args:
                model_free_dimension: 267 # Obtained by LPCA with threshold 0.001
        - base_model:
            config_dir: checkpoints-jjohg4sc/chest_xray_mvioxhbl/run_config.json
            checkpoint_dir: checkpoints-jjohg4sc/chest_xray_mvioxhbl/checkpoints/de_VPSDE_Diffusion_latest.pt
          data:
            in_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: ChestMNIST
                  align: False
            out_of_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: PneumoniaMNIST
          ood:
            method_args:
              scale_selection_algorithm_args:
                model_free_dimension: 90 # Obtained by LPCA with threshold 0.001
        - base_model:
            config_dir: checkpoints-jjohg4sc/pneumonia_chest_xray_v2lg5j0w/run_config.json
            checkpoint_dir: checkpoints-jjohg4sc/pneumonia_chest_xray_v2lg5j0w/checkpoints/de_VPSDE_Diffusion_latest.pt
          data:
            in_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: PneumoniaMNIST
            out_of_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: ChestMNIST
                  align: False
          ood:
            method_args:
              scale_selection_algorithm_args:
                model_free_dimension: 98 # Obtained by LPCA with threshold 0.001      
        - base_model:
            config_dir: checkpoints-jjohg4sc/chest_xray_mvioxhbl/run_config.json
            checkpoint_dir: checkpoints-jjohg4sc/chest_xray_mvioxhbl/checkpoints/de_VPSDE_Diffusion_latest.pt
          data:
            in_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: ChestMNIST
                  align: False
            out_of_distribution:
              dataloader_args:
                additional_dataset_args:
                  resize_image: [32, 32]
                  subclass: ChestMNIST
                  align: False
          ood:
            method_args:
              scale_selection_algorithm_args:
                model_free_dimension: 90 # Obtained by LPCA with threshold 0.001
    
    - sweep: True
      sweep_identifier: A_subsample_size # run on different subsample sizes to tradeoff speed for accuracy!
      sweep_alias:
      - tiny
      - medium
      - huge
      values:
      - ood:
          use_dataloader: True
          pick_count: 1
      - ood:
          use_dataloader: True
          pick_count: 4
      - ood:
          use_dataloader: True
          pick_count: 256
    
